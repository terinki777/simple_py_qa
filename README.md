## Содержание
- ### [Запуск тестов в Gitlab CI](#запуск-тестов-в-gitlab-ci-1)
- ### [Запуск на локальной машине в docker с использованием docker-compose](#запуск-на-локальной-машине-в-docker-с-использованием-docker-compose-1)
- ### [Подготовка PyCharm IDE к работе](#подготовка-pycharm-ide-к-работе-1)
- ### [Структура проекта](#структура-проекта-1)



## Запуск тестов в Gitlab CI

  В проекте настроена автоматическая сборка docker-контейнеров и запуск тестов при коммите в ветку master.  
  Посмотреть историю запущенных pipeline можно в разделе CI / CD слайдбара проекта.
  
### Для запуска pipeline (сборка необходимых контейнеров и запуск тестов) вручную, необходимо:
- #### Открыть раздел CI / CD и нажать кнопку 'Run Pipeline'
- #### Добавить список email-адресов для рассылки, в разделе 'Variables' указать:
	- ##### для поля 'Input variable key':  
          EMAILS
	- ##### для поля 'Input variable value': список адресов, разделитель точка с запятой (;), к примеру:  
          user1@example.ru;user2@example2.ru
- #### нажать кнопку 'Run Pipeline'
- #### дождаться выполнения всех шагов
- #### открыть сформированный allur-отчет по адресу: https://kholstinin.gitlab.io/x5_demo/

  По адресу https://kholstinin.gitlab.io/x5_demo/ доступен только отчет по последнему прогону тестов.  
  Посмотреть результаты выполнения предыдущих прогонов можно в разделе 'CI / CD' в слайдбаре:           
   - Открыть раздел 'CI / CD'
   - Нажать на идентификатор нужного 'Pipeline'
   - Нажать на выполненный шаг 'Pages' (зеленая галочка в зеленом кружке)
   - В разделе 'Job artifacts' нажать на кнопку 'Browse'
   - В директории 'public' нажать на 'index.html' - отчет откроется в новой вкладке браузера



## Запуск на локальной машине в docker, с использованием docker-compose

После выполнения данного шага:
  - будут собраны два контейнера, с проектом и дистрибутивом allure  
  - загружены образы для запуска selenoid (selenoid/video-recorder:latest-release, aerokube/selenoid:1.10.0, selenoid/chrome:80.0)  
  - произведен запуск тестов и сформирован allure-отчет  

Перед запуском необходимо убедиться, что в системе отсутствуют docker-образы с названиями **allure-cli** и **x5-demo**.  
Посмотреть список существующих образов можно командой:

    docker images |grep -E "allure-cli|x5-demo"
  
- ### Зависимости: 
      linux, git, docker, docker-compose, доступ в интернет

- ### Создать директории для allure-отчетов:
      mkdir allure-results
      mkdir allure-reports

- ### Склонировать репозиторий https://gitlab.com/kholstinin/x5_demo.git:
      git clone https://x5_demo_token@gitlab.com/kholstinin/x5_demo.git
  ##### Токен для доступа:
    - login: x5_demo_token
    - password: n_M1rW8nhbF3pXmw2rxx

- ### Сменить директорию на каталог репозитория:
      cd x5_demo

- ### Внести изменения в файл **.env**:
  - Указать полный путь до ранее созданных директорий **REPORT_DIR** и **RESULT_DIR**
  - Указать список email-адресов для рассылки писем **EMAILS** (в качестве разделителя, точка с запятой ';')
  - Указать **ALLURE_PORT** - внешний порт для docker сервера (если allure был запущен в режиме просмотра отчета), по умолчанию 80 порт
  - Выбрать один из двух вариантов запуска allure (раскомментировав нужный):
    - Генерация и просмотр отчета в браузере (дополнительно будет запущен allure сервер)
    - Только генерация отчета

- ### Выполнить команды в терминале:
      docker-compose up

  После удачного выполнения команды, в терминале должен появиться данный текст:
  
      Tests finished!
      Report successfully generated to /allure-results
  
  В директории **RESULT_DIR** будет находиться готовый allure отчет.  
  Дополнительно будет запущен allure сервер для просмотра сформированного отчета.
  Отчет можно посмотреть по адресу:
  
      http://_ip_адрес_docker_сервера_/
  либо:
    
      http://_ip_адрес_docker_сервера_:ALLURE_PORT/ (в случае если ALLURE_PORT отличен от 80)

- ### Остановить docker-контейнеры по завершении тестирования
    Выполнить команды:
    
      <Ctrl+C> - остановить allure сервер (если он был запущен для просмотра результатов в браузере)  
      docker-compose down
  

- ### При необходимости, можно запустить ранее собранный docker-контейнер allure-cli и посмотреть сформированный отчет:
  Выполнить команды:
  
      docker run -p 80:80 -v "_полный_путь_к_директории_allure-results_:/allure-results" allure-cli allure open /allure-results -p 80
  К примеру:
      
      docker run -p 80:80 -v "/home/user/allure-results:/allure-results" allure-cli allure open /allure-results -p 80
  Посмотреть отчет можно в браузере, введя в адресную строку: **http://_ip_адрес_docker_/**



## Подготовка PyCharm IDE к работе
 
- ### Клонируем проект через систему контроля версий
	- заходим VСS -> Checkout from version Control -> Git
	- вводим https://gitlab.com/kholstinin/x5_demo.git в поле url
	- нажимаем clone
	- после удачного клонирования проекта - появится предложение установить requirements, на данном этапе ничего не нажимаем

- ### Настройка проекта и создание виртуальной среды
	- открываем File -> Settings
	- в открывшемся окне: Project -> Project Interpreter
	- нажимаем на 'шестеренку' - 'add'
	- в открывшемся окне нажимаем 'ok'
	- ждём создания виртуальной среды
	- нажимаем 'apply', 'ok'
	
- ### Устанавливаем зависимости проекта
	- Соглашаемся на предложение устанавливать requirements.

- ### Выбираем ранером PyTest
    - открываем File -> Settings
	- в открывшемся окне: Tools -> Python Integrated Tools
	- в поле 'Default test runner' выбираем 'pytest'
	- нажимаем 'apply', 'ok'

- ### Копируем chromedriver в директорию framework/drivers/_Тип_ОС_
	- Скачиваем [chromedriver](https://chromedriver.chromium.org/downloads), версия драйвера должна соответствовать версии вашего браузера и ОС  
	- копируем в вышеуказанную директорию


  Если все шаги прошли успешно - можно произвести запуск тестов средствами IDE PyCharm



## Структура проекта
  
 - **framework/**
	- **drivers/** - директория для хранения драйверов для браузеров
	- **resources/** - ресурсы и тестовые данные
		- **img/** - директория для хранения различных ресурсов, необходимых для выполнения тестовых сценариев
		- **test_params/** - директория для хранения тестовых данных, необходимых для выполнения тестовых сценариев
	- **ui_pages/** - директория для хранения PO
	- **config.py** - вспомогательный класс для конфигурации проекта во время выполнения
	- **utils.py** - различные вспомогательные утилилты
	- **webdriver_manager.py** - вспомогательный класс для управления Web драйвером

- **reports/** - директория для хранения результирующих отчетов

- **tests/** - директория для хранения тестовых классов
	- **ui/** - директория для хранения тестовых классов для UI-тестирования

- **requirements.txt** - зависимости проекта

- **defaults.ini** - файл с конфигурацией проекта
- **pytest.ini** - файл с конфигурацией pytest

- **Dockerfile** - файл для сборки docker-контейнера с проектом
- **wait-for** - скрипт для docker-контейнера с проектом (ожидание старта selenoid в docker-compose)
- **Dockerfile_allure** - файл для сборки docker-контейнера с allure

- **browsers.json** - конфигурационный файл selenoid

- **.gitlab-ci.yml** - конфигурационный файл для Gitlab CI

- **docker-compose.yml** - конфигурационный файл для docker-compose
- **.env** - переменные окружения для docker-compose
